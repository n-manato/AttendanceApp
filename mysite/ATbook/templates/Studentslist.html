{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}
<!DOCTYPE html>
<html>
  <head>
    {% bootstrap_css %}
    {% bootstrap_javascript %}
  </head>
  <body class="">
    {% block content %}
      <link rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
      <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
      <section class="intro">
        <div class="gradient-custom-2 h-100">
          <div class="mask d-flex align-items-center h-100">
            <div class="container">
              <div class="row justify-content-center">
                <div class="col-12">
                  <h1 style="color: white;">Student: {{ student }}</h1>
                  <form method="POST" id="select-form">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="subject-select" class="form-label" style="color: white;">Select Subject:</label>
                      <select class="form-select bg-dark text-white border-dark"
                              id="subject-select"
                              name="subject">
                        <option value="">Choose Subject</option>
                        {% for subject in subjects %}
                          <option value="{{ subject.subject }}"
                                  {% if subject.subject == selected_subject.subject %}selected{% endif %}>
                            {{ subject.subject }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="row">
                      <div class="col">
                        <div class="form-group">
                          <label for="start-date" class="form-label" style="color: white;">Start Date:</label>
                          <input type="date"
                                 class="form-control bg-dark text-white border-dark"
                                 id="start_date"
                                 name="start_date"
                                 {% if selected_start %}value="{{ selected_start }}"{% endif %}>
                        </div>
                      </div>
                      <div class="col">
                        <div class="form-group">
                          <label for="end-date" class="form-label" style="color: white;">End Date:</label>
                          <input type="date"
                                 class="form-control bg-dark text-white border-dark"
                                 id="end_date"
                                 name="end_date"
                                 {% if selected_end %}value="{{ selected_end }}"{% endif %}>
                        </div>
                      </div>
                    </div>
                    <div class="mb-3"></div>
                  </form>
                  <div class="table-responsive table-container">
                    <table id="student-table" class="table table-dark table-bordered mb-0">
                      <thead>
                        <tr>
                          <th scope="col" style="color: white;">Total</th>
                          {% for name, data in attendanceinfo.items %}
                          {%for date ,info in data.items%}
                          {%for hour ,infos in info.items%}
                          <th>{{ date }}:{{hour}}</th>{% endfor %}{% endfor %}{% endfor %}
                        </thead>
                        <tbody>

                            {% for fullname, datas in attendanceinfo.items %}
                              <tr>
                                <td>{{datas.total}}</td>
                                {% for dates, infos in datas.items %}
                                {%for hour ,info in infos.items%}
                                  <td>
                                    {% if info.first_half == '出席' %}
                                      <i class="fas fa-check-circle text-success"></i>
                                    {% elif info.first_half == '欠席' %}
                                      <i class="fas fa-times-circle text-danger"></i>
                                    {% elif info.first_half == None %}
                                      <i class="fas fa-question-circle text-secondary"></i>
                                    {% endif %}
                                    {% if info.latter_half == '出席' %}
                                      <i class="fas fa-check-circle text-success"></i>
                                    {% elif info.latter_half == '欠席' %}
                                      <i class="fas fa-times-circle text-danger"></i>
                                    {% elif info.latter_half == None %}
                                      <i class="fas fa-question-circle text-secondary"></i>
                                    {% endif %}
                                    
                                  </td>
                                {% endfor %}
                                {% endfor %}
                              </tr>
                            {% endfor %}

                        </tbody>
                      </table>
                    </div>
                    <div class="row justify-content-center mt-3">
                      <div class="col-6">
                        <button type="csv"
                                id="csv-btn"
                                class="btn btn-primary w-100"
                                name="csv">Download CSV</button>
                      </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      {% endblock %}
      {% block scripts %}
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <script>
                $(document).ready(function() {
                var csrftoken = "{{ csrf_token }}";
                function sendPOSTRequest() {
                    var startDate = $("#start_date").val();
                    var endDate = $("#end_date").val();
                    var selected_subject = $("#subject-select").val();
                    if (startDate !== "" && endDate !== "" && selected_subject !== ""){
                        $("#select-form").submit();
                    }
                }
                $("#subject-select, #start_date, #end_date").change(function() {
                    event.preventDefault();
                    sendPOSTRequest(); // 新しく作成した関数を呼び出す
                });
            });
        </script>
      {% endblock %}
    </body>
  </html>
