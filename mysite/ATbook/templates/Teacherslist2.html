{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}
<!DOCTYPE html>
<html>
    <head>
        {% bootstrap_css %}
        {% bootstrap_javascript %}
    </head>
    <body class="">
        {% block content %}
            <link rel="stylesheet"
                  href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
            <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
            <section class="intro">
                <div class="gradient-custom-2 h-100">
                    <div class="mask d-flex align-items-center h-100">
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-12">
                                    <h1 style="color: white;">アカウント名: {{ username }}</h1>
                                    <form method="POST" id="select-form">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col">
                                                <div class="form-group">
                                                    <label for="start-date" class="form-label" style="color: white;">開始日:</label>
                                                    <input type="date"
                                                           class="form-control bg-dark text-white border-dark"
                                                           id="start_date"
                                                           name="start_date"
                                                           {% if selected_start %}value="{{ selected_start }}"{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-group">
                                                    <label for="end-date" class="form-label" style="color: white;">終了日:</label>
                                                    <input type="date"
                                                           class="form-control bg-dark text-white border-dark"
                                                           id="end_date"
                                                           name="end_date"
                                                           {% if selected_end %}value="{{ selected_end }}"{% endif %}>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3"></div>
                                    </form>
                                    <div class="table-responsive table-container">
                                        <table id="student-table" class="table table-dark table-bordered mb-0">
                                            <thead>
                                                <th scope="col">氏名</th>
                                                <th scope="col">遅/早/休</th>
                                                {% for subject_data in subject_list %}<th>{{ subject_data }}</th>{% endfor %}
                                            </thead>
                                            <tbody>
                                                {% for fullname, subject in attendance_dict.items %}
                                                    <tr>
                                                        <td>{{ fullname }}</td>
                                                        <td>{{ subject.total }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <form method="POST" id="select-form2">
                                    {% csrf_token %}
                                <div class="row justify-content-center mt-3">
                                    <div class="col-6">
                                        
                                        <button type="submit"
                                        id="csv-btn"
                                        class="btn btn-primary w-100"
                                        name="download"
                                        value="csv">CSVをダウンロード</button>
                                        <input type="hidden" name="download" value="download">
                                    
                                    </div>
                            </div>
                        </form>
                            </div>
                        </div>
                    </div>
                </section>
            {% endblock %}
            {% block scripts %}
            <script src="{% static 'js/jquery.min.js' %}"></script>
                <script>
                $(document).ready(function() {
                var csrftoken = "{{ csrf_token }}";
                function sendPOSTRequest() {
                    var startDate = $("#start_date").val();
                    var endDate = $("#end_date").val();
                    if (startDate !== "" && endDate !== ""){
                        $("#select-form").submit();
                    }
                }
                function CSVPOSTRequest(formId, downloadValue) {
                    var startDate = $("#start_date").val();
                    var endDate = $("#end_date").val();
                    
                    if (startDate !== "" && endDate !== ""){
                        var form = $("#" + formId);
                        var input = $("<input>")
                        .attr("type", "hidden")
                        .attr("name", "download")
                        .val(downloadValue);
                        form.append(input);
                        form.submit();
                    }
                    
                }
                $("#start_date, #end_date").change(function() {
                    event.preventDefault();
                    sendPOSTRequest(); // 新しく作成した関数を呼び出す
                });
                $("#csv-btn").click(function() {
                    event.preventDefault();
                    CSVPOSTRequest("select-form", "download");
                });
            });
                </script>
            {% endblock %}
        </body>
    </html>
